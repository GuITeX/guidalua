\NeedsTeXFormat{LaTeX2e}[1995/06/01]
\ProvidesPackage{sourcecode}
    [2021/04/06 v0.2 Sourcecode Lua script]

% setup listings
\lstdefinestyle{lua}{
    language=[5.3]Lua,
    basicstyle=\small\ttfamily,
    keywordstyle=\color{blue},
    stringstyle=\color{orange},
    commentstyle=\color{black!80}
}

\lstdefinestyle{out}{
    frame=tb,
    basicstyle=\small\ttfamily
}

\directlua{
sourcecodelib = require [[sourcecode]]
sourcecodelib._tkprint = tex.print
}

% opzione run = false
\newenvironment{lines}{\directlua{
    luatexbase.add_to_callback(
        'process_input_buffer',
        sourcecodelib.process_input_buffer,
        'sourcecodelib:lines',
        1
    )
}}{\directlua{
    luatexbase.remove_from_callback(
        'process_input_buffer',
        'sourcecodelib:lines'
    )
    sourcecodelib
        :trim_tail()
        :typeset()
}}

% run = true
\newenvironment{linesrun}{\directlua{
    sourcecodelib:option{run=true}
    luatexbase.add_to_callback(
        'process_input_buffer',
        sourcecodelib.process_input_buffer_star,
        'sourcecodelib:linesstar',
        1
    )
}}{\directlua{
    luatexbase.remove_from_callback(
        'process_input_buffer',
        'sourcecodelib:linesstar'
    )
    sourcecodelib
        :trim_tail()
        :typeset()
}}


\newcommand\sourcecode[1]{\directlua{
    sourcecodelib
        :option{#1}
        :load_file()
        :typeset()
}}

\endinput
